<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Exit Intent</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <section id="exit-intent">
        <div id="ouibounce-modal" class="desktop-exit">
            <div class="underlay"></div>
            <div class="exit-modal-desktop">
                <div class="modal-box">
                    <div class="left">
                        <img alt="SkinnyFit Limited Time Offer" src="https://dist1.skinnyfitdetox.com/images/glp/SF_Website_Lander_New-Design_GLP1_Exit-Intent_Desktop.jpg">
                    </div>
                    <div class="right">
                        <div class="close-desktop-exit">×</div>
                        <div class="copy">
                            <h2>SPECIAL OFFER</h2>
                            <h3>Try it today for just</h3>
                            <h4>$19.95</h4>
                            <cta-glp-1item-sub-exit>
                                <button type="button" class="cta-glp-1item-sub-exit my-button" data-product-id="9409658683637" data-variant-id="47279918481653" data-selling-plan-id="4822827253">TRY IT FOR $19.95 »</button>
                            </cta-glp-1item-sub-exit>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mobile-exit" style="display: none;">
            <div class="exit-modal-mobile">
                <div class="button-container">
                    <h2>SPECIAL OFFER</h2>
                    <cta-glp-1item-sub-exit>
                        <button type="button" class="cta-glp-1item-sub-exit my-button" data-product-id="9409658683637" data-variant-id="47279918481653" data-selling-plan-id="4822827253">TRY IT FOR $19.95 »</button>
                    </cta-glp-1item-sub-exit>
                    <p class="guarantee"><span class="checkmark"></span> FREE Shipping + $50 in FREE Gifts.</p>
                </div>
                <div class="close-mobile-exit">×</div>
                <div class="close-mobile-exit expand hidden">+</div>
            </div>
        </div>
    </section>
    <script>
        (function() {
        var script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/ouibounce/0.0.12/ouibounce.min.js';
        script.onload = initOuibounce;
        document.head.appendChild(script);
        })();

        function initOuibounce() {
        const modal = document.getElementById('ouibounce-modal');

        const instance = ouibounce(modal, {
            aggressive: true,
            sensitivity: 20,
            timer: 1000,
            delay: 0,
            cookieExpire: 7,
            callback: function() {
                modal.style.display = 'block';
            }
        });

        // Close handlers
        document.querySelectorAll('.close-desktop-exit').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        });
    }
    </script>
    <script>
        // get scroll speed on lander
        const checkScrollSpeed = (function () {
            let lastPos;
            let newPos;
            let timer;
            let delta;
            const delay = 50; // in "ms" (higher means lower fidelity)

            function clear() {
            lastPos = null;
            delta = 0;
            }

            clear();

            return function () {
            newPos = window.scrollY;
            if (lastPos != null) {
                delta = newPos - lastPos;
            }
            lastPos = newPos;
            clearTimeout(timer);
            timer = setTimeout(clear, delay);
            return delta;
            };
        })();

        // slideDown helper (vanilla)
        function slideDown(el, duration = 300) {
            if (!el) return;
            // if already visible, do nothing
            const style = window.getComputedStyle(el);
            if (style.display !== 'none' && parseFloat(style.opacity || '1') > 0) return;

            // prepare element
            el.style.removeProperty('display');
            let display = window.getComputedStyle(el).display;
            if (display === 'none') display = 'block';
            el.style.display = display;

            const height = el.scrollHeight;

            el.style.overflow = 'hidden';
            el.style.height = '0px';
            el.style.opacity = 0;
            // force reflow so the starting styles are applied
            el.getBoundingClientRect();

            el.style.transition = `height ${duration}ms ease, opacity ${duration}ms ease`;
            requestAnimationFrame(() => {
            el.style.height = height + 'px';
            el.style.opacity = 1;
            });

            // cleanup after animation
            setTimeout(() => {
            el.style.removeProperty('height');
            el.style.removeProperty('overflow');
            el.style.removeProperty('transition');
            el.style.removeProperty('opacity');
            }, duration);
        }

        let potentialExit = false;
        let tempPosition = 0;
        let exitShown = false;
        const userAgent = navigator.userAgent || '';

        // listen to "scroll" event
        window.addEventListener('scroll', () => {
            if (window.innerWidth < 768) {
            if (exitShown === false) {
                if (potentialExit === false) {
                if (/android/i.test(userAgent)) {
                    if (checkScrollSpeed() < -50) {
                    potentialExit = true;
                    setTimeout(() => {
                        potentialExit = false;
                    }, 800);
                    tempPosition = window.scrollY;
                    }
                } else {
                    if (checkScrollSpeed() < -10) {
                    potentialExit = true;
                    setTimeout(() => {
                        potentialExit = false;
                    }, 800);
                    tempPosition = window.scrollY;
                    }
                }
                } else {
                const mobileExitEl = document.querySelector('.mobile-exit');

                if (/android/i.test(userAgent)) {
                    if ((tempPosition - window.scrollY) > 1000) {
                    exitShown = true;
                    slideDown(mobileExitEl, 300);
                    }
                }
                if ((tempPosition - window.scrollY) > 300) {
                    exitShown = true;
                    slideDown(mobileExitEl, 300);
                }
                }
            }
            }
        });
    </script>
    <script>
        document.querySelectorAll('.close-mobile-exit').forEach(function (button) {
            button.addEventListener('click', function () {
                document.querySelectorAll('.close-mobile-exit').forEach(function (el) {
                    el.classList.toggle('hidden');
                });
                document.querySelectorAll('.mobile-exit').forEach(function (el) {
                    el.classList.toggle('collapsed');
                });
            });
        });
    </script>
    <script>
  (function() {
    class CtaGlp1ItemSubExit extends HTMLElement {
      constructor() {
        super();
        this.button = this.querySelector('.cta-glp-1item-sub-exit');
      }

      connectedCallback() {
        this.button.addEventListener('click', this.handleBuyNow.bind(this));
      }

      async handleBuyNow(event) {
        event.preventDefault();
        
        const button = event.target;
        const variantId = button.dataset.variantId;
        const sellingPlanId = button.dataset.sellingPlanId;
        
        if (!variantId) {
          console.error('No variant ID found');
          return;
        }

        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = 'Processing...';

        try {
          const response = await fetch('/cart/clear.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          if (response.ok) {
            if (window.location.pathname === '/cart') {
              window.location.reload();
            } else {
              document.dispatchEvent(new CustomEvent('cart:refresh'));
              
              const cartCountElements = document.querySelectorAll('[data-cart-count], .cart-count, #cart-icon-bubble');
              cartCountElements.forEach(element => {
                if (element.querySelector('span')) {
                  element.querySelector('span').textContent = '0';
                } else {
                  element.textContent = '0';
                }
              });
            }
          } else {
            console.error('Failed to clear cart');
          }
        } catch (error) {
          console.error('Error clearing cart:', error);
        }

        try {
          const formData = {
            items: [, {
              id: '47312317776117',
              quantity: 1
            }, {
              id: '47312298475765',
              quantity: 1
            }, {
              id: variantId,
              quantity: 1,
              selling_plan: sellingPlanId
            }]
          };

          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
          });

          console.log('response: ', response)

          if (!response.ok) {
            throw new Error('Failed to add to cart');
          }

          window.location.href = '/checkout';
          setTimeout(function () {
            button.textContent = originalText;
          }, 1000);
        } catch (error) {
          console.error('Error:', error);
          button.textContent = originalText;
          button.disabled = false;
          alert('There was an error processing your request. Please try again.');
        }
      }
    }

    customElements.define('cta-glp-1item-sub-exit', CtaGlp1ItemSubExit);
  })();
    </script>
  </body>
</html>